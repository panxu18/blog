#### RDB

RDB持久化是指在指定的时间间隔内将内存中数据以快照的方式写入到二进制文件中,**默认的文件名为dump.rdb**。

##### 触发方式

- save触发，该命令会阻塞当前Redis服务器，执行save命令期间，Redis不能处理其他命令，直到RDB过程完成为止。
- bgsave触发，执行该命令时，Redis会在后台异步进行快照操作，快照同时还可以响应客户端请求。具体操作是Redis进程执行fork操作创建子进程，RDB持久化过程由子进程负责，完成后自动结束。阻塞只发生在fork阶段，一般时间很短。基本上 Redis 内部所有的RDB操作都是采用 bgsave 命令
- 自动触发，通过在配置文件配置`save time count`，在指定时间内修改达到count次数自动触发bgsave。

##### 特点

- RDB文件紧凑，全量备份，适合用于进行备份和灾难恢复。
- 生成RDB文件的时候，redis主进程会fork()一个子进程来处理所有保存工作，主进程不需要进行任何磁盘IO操作。
- RDB 在恢复大数据集时的速度比 AOF 的恢复速度要快。
- fork进程写时复制的影响，在快照持久化期间修改的数据不会被保存。

#### AOF

Redis会将每一个收到的写命令都通过write函数追加到文件中，通俗的理解就是日志记录。

##### 落盘机制	

1. always：每次发生数据变更会被立即记录到磁盘 性能较差但数据完整性比较好。
2. everysec：异步操作，每秒记录 如果一秒内宕机，有数据丢失。
3. no：不同步，等待文件系统同步。

##### 特点

1. AOF可以更好的保护数据不丢失，一般AOF会每隔1秒，通过一个后台线程执行一次fsync操作，最多丢失1秒钟的数据。
2. AOF日志文件没有任何磁盘寻址的开销，写入性能非常高，文件不容易破损。
3. AOF日志文件即使过大的时候，出现后台重写操作，也不会影响客户端的读写。
4. AOF日志文件的命令通过非常可读的方式进行记录，这个特性非常适合做灾难性的误删除的紧急恢复。比如某人不小心用flushall命令清空了所有数据，只要这个时候后台rewrite还没有发生，那么就可以立即拷贝AOF文件，将最后一条flushall命令给删了，然后再将该AOF文件放回去，就可以通过恢复机制，自动恢复所有数据。
5. 对于同一份数据来说，AOF日志文件通常比RDB数据快照文件更大。
6. AOF开启后，支持的写QPS会比RDB支持的写QPS低，因为AOF一般会配置成每秒fsync一次日志文件，当然，每秒一次fsync，性能也还是很高的。

##### 混合持久化

将 rdb 文件的内容和增量的 AOF 日志文件存在一起。这里的 AOF 日志不再是全量的日志，而是自持久化开始到持久化结束的这段时间发生的增量 AOF 日志，通常这部分 AOF 日志很小。于是在 Redis 重启的时候，可以先加载 rdb 的内容，然后再重放增量 AOF 日志就可以完全替代之前的 AOF 全量文件重放，重启效率因此得到大幅提升。